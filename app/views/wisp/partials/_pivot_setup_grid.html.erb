<div id="pivotDataGrid">

        <script type="text/javascript">
        <%= grid_javascript_settings %>
          // If pivot_id is set, load the field grid for that one. If it's zero,
          // grab the id of the first pivot in the grid and use that.
          function loadFieldGrid(throwaway1,throwaway2) {
            // alert('loadFieldGrid');
            if (pivot_id == 0) {
              pivot_id = $("#pivot_setup").getDataIDs()[0];
            }
            $('#fieldDataGrid').load('<%= url_for :controller => "wisp", :action => :field_setup_grid %>',
              // {pivot_id:pivot_id,user_id:user_id, farm_id:farm_id});
              '&pivot_id='+pivot_id+'&farm_id='+farm_id);
          }
          function rowSelect(id) {
            if(id) {
              jQuery('#pivot_setup').editRow(id,true,null,updatePivotSelectName);
              pivot_id=id;
              loadFieldGrid(); // will load for the pivot id we just selected
            }
          }

          function reloadGrids(pivot_id) {
            $('#pivotDataGrid').load('<%= url_for :controller => "wisp", :action => :pivot_crop %>',
            '&farm_id='+farm_id+'&parent_id='+farm_id+'&pivot_id='+pivot_id+'&ajax=true');
          }
          function reloadPage() {
            url = '<%= url_for(:controller => "wisp", :action => :pivot_crop, :pivot_id => "", :field_id => "") %>';
            window.location.href=url;
          }
          function deletePivot(id) {
            pivot_id = 0; // We no longer know what the current one is; find out after grids reload
            jQuery('#pivot_setup').delGridRow(id,{afterSubmit:reloadPage});
          }
          function addPivotToSelect(id,pivot_data) {
            $('#pivot_id').append($('<option/>', {
                    value: id,
                    text : pivot_data['name'],
                }));
            reloadGrids(id);
          }
          function updatePivotSelectName(response) {
            var json = $.parseJSON(response.responseText)
            var name = json['name'];
            var id = json['id'];
            $('#pivot_id option[value='+id+']').text(name);
            $('#pivot').val(id);
            loadFieldGrid();
            return(true);
          }
          function addPivotDeleteButtons() {
            var ids = jQuery("#pivot_setup").getDataIDs();
            nRows = ids.length;
            for(var i=0;i<nRows;i++){
              var id = ids[i];
                be = "<input style='height:22px;width:35px;' type='button' value='Del' onclick='deletePivot("+id+");' ></ids>";
                jQuery("#pivot_setup").setRowData(id,{act:be});
            }
          }
          function addNewPivotRow() {
            var grid = $('#pivot_setup');
            newPivot = createNewPivot();
            pivot_id = newPivot['id'];
            grid.addRowData(pivot_id, newPivot); // add a new row with the new field's data
            addPivotDeleteButtons();
            addPivotToSelect(pivot_id,newPivot);
            grid.editRow(pivot_id,true,null,updatePivotSelectName); // put new row into inline-edit mode
          }

          function createNewPivot() {
            var pvt={};
            $.ajax(
              {
                type: "POST",
                url: '<%= url_for :controller => 'pivots', :action => :post_data %>',
                dataType: "json",
                data: {farm_id:farm_id,parent_id:farm_id,oper:'add',id:'_empty'},
                contentType: "application/x-www-form-urlencoded", // This is so Rails knows to decode it
                async: false,
                success: function(json) {
                  pvt = json;
                }
              }
            );
            return pvt;
          }

          jQuery(document).ready(function(){
            // Load the dependent field and crop grids with appropriate values
            <%= grid_javascript_settings %> // Sets pivot_id
            loadFieldGrid();
            var mygrid = jQuery("#pivot_setup").jqGrid({
              url:'<%= url_for(:controller => "pivots", :q => 1, :farm_id => @farm_id) %>&pivot_id='+pivot_id,
              editurl:'<%= grid_post_data_url "pivots", @farm_id %>',
              datatype: "json",
              // t.integer  "farm_id"
              // t.string   "name"
              // t.float    "latitude"
              // t.float    "longitude"
              // t.string   "equipment"
              // t.float    "pump_capacity"
              // t.float    "some_energy_rate_metric"
              // t.integer  "cropping_year"
              // t.string   "notes"
              //
              colNames:['Name','Lat.','Long.','Equipment','Pump Capacity','Energy','Crop Yr','Notes','Delete','Farm ID','ID'],
              // colNames:['Name',' '],
              colModel:[
                         {name:'name', index:'name',width:83,editable:true},
                         {name:'latitude', index:'latitude',width:18,editable:true, align:'right',editrules:{number:true,minValue:42.0,maxValue:50.0}},
                         {name:'longitude', index:'longitude',width:18,editable:true, align:'right',editrules:{number:true,minValue:-98.0,maxValue:-86.0}},
                         {name:'equipment', index:'equipment',width:60,editable:true, align:'right'},
                         {name:'pump_capacity', index:'pump_capacity',width:50,editable:true, align:'right',editrules:{number:true,minValue:0.0}},
                         {name:'some_energy_rate_metric', index:'some_energy_rate_metric',width:25,editable:true, align:'right',editrules:{number:true,minValue:0.0}},
                         {name:'cropping_year', index:'cropping_year',width:25,editable:false, align:'right'},
                         {name:'notes', index:'notes',width:100,editable:true, align:'right'},
                         {name:'act', index:'act', width:20},
                         {name:'farm_id',index:'farm_id',width:10,hidden:true,editable:true},
                         {name:'id', index:'id',width:1,hidden:true,editable:true},
                         ],
              pager: '#pivot_setup_pager',
              rowNum:1,
              rowList:[1],
              imgpath: '<%= image_folder_path("jqgrid") %>',
              sortname: '',
              viewrecords: true,
              height: 22,
              width: 918,
              sortorder: '',
              gridview: false,
              scrollrows: true,
              autowidth: false,
              rownumbers: false,
              multiselect: false,

              loadComplete: function(){
                  addPivotDeleteButtons();
              },
              onSelectRow: rowSelect,
              subGrid:false,

              caption: "Pivot <%= @farm ? "for #{@farm.name}" : '' %>"
            })
          });

        </script>

        <table id="pivot_setup" class="scroll" cellpadding="0" cellspacing="0"></table>
        <button type="button" onclick="addNewPivotRow();">Add New Pivot</button>

        <!-- <div id="pivot_setup_pager" class="scroll" style="text-align:center;"></div> -->

</div>
