Bluff={VERSION:"0.3.6",array:function(a){if(a.length===undefined)return[a];var b=[],c=a.length;while(c--)b[c]=a[c];return b},array_new:function(a,b){var c=[];while(a--)c.push(b);return c},each:function(a,b,c){for(var d=0,e=a.length;d<e;d++){b.call(c||null,a[d],d)}},index:function(a,b){for(var c=0,d=a.length;c<d;c++){if(a[c]===b)return c}return-1},keys:function(a){var b=[],c;for(c in a)b.push(c);return b},map:function(a,b,c){var d=[];this.each(a,function(a){d.push(b.call(c||null,a))});return d},reverse_each:function(a,b,c){var d=a.length;while(d--)b.call(c||null,a[d],d)},sum:function(a){var b=0,c=a.length;while(c--)b+=a[c];return b},Mini:{}};Bluff.Base=new JS.Class({extend:{DEBUG:false,DATA_LABEL_INDEX:0,DATA_VALUES_INDEX:1,DATA_COLOR_INDEX:2,LEGEND_MARGIN:20,TITLE_MARGIN:20,LABEL_MARGIN:10,DEFAULT_MARGIN:20,DEFAULT_TARGET_WIDTH:800,THOUSAND_SEPARATOR:","},top_margin:null,bottom_margin:null,right_margin:null,left_margin:null,title_margin:null,legend_margin:null,labels:null,center_labels_over_point:null,has_left_labels:null,x_axis_label:null,y_axis_label:null,y_axis_increment:null,colors:null,title:null,font:null,font_color:null,hide_line_markers:null,hide_legend:null,hide_title:null,hide_line_numbers:null,no_data_message:null,title_font_size:null,legend_font_size:null,marker_font_size:null,marker_color:null,marker_count:null,minimum_value:null,maximum_value:null,sort:null,additional_line_values:null,stacked:null,legend_box_size:null,tooltips:false,initialize:function(a,b){this._d=new Bluff.Renderer(a);b=b||this.klass.DEFAULT_TARGET_WIDTH;var c;if(typeof b!=="number"){c=b.split("x");this._columns=parseFloat(c[0]);this._rows=parseFloat(c[1])}else{this._columns=parseFloat(b);this._rows=this._columns*.75}this.initialize_ivars();this._reset_themes();this.theme_keynote();this._listeners={}},initialize_ivars:function(){this._raw_columns=800;this._raw_rows=800*(this._rows/this._columns);this._column_count=0;this.marker_count=null;this.maximum_value=this.minimum_value=null;this._has_data=false;this._data=[];this.labels={};this._labels_seen={};this.sort=true;this.title=null;this._scale=this._columns/this._raw_columns;this.marker_font_size=21;this.legend_font_size=20;this.title_font_size=36;this.top_margin=this.bottom_margin=this.left_margin=this.right_margin=this.klass.DEFAULT_MARGIN;this.legend_margin=this.klass.LEGEND_MARGIN;this.title_margin=this.klass.TITLE_MARGIN;this.legend_box_size=20;this.no_data_message="No Data";this.hide_line_markers=this.hide_legend=this.hide_title=this.hide_line_numbers=false;this.center_labels_over_point=true;this.has_left_labels=false;this.additional_line_values=[];this._additional_line_colors=[];this._theme_options={};this.x_axis_label=this.y_axis_label=null;this.y_axis_increment=null;this.stacked=null;this._norm_data=null},set_margins:function(a){this.top_margin=this.left_margin=this.right_margin=this.bottom_margin=a},set_font:function(a){this.font=a;this._d.font=this.font},add_color:function(a){this.colors.push(a)},replace_colors:function(a){this.colors=a||[];this._color_index=0},set_theme:function(a){this._reset_themes();this._theme_options={colors:["black","white"],additional_line_colors:[],marker_color:"white",font_color:"black",background_colors:null,background_image:null};for(var b in a)this._theme_options[b]=a[b];this.colors=this._theme_options.colors;this.marker_color=this._theme_options.marker_color;this.font_color=this._theme_options.font_color||this.marker_color;this._additional_line_colors=this._theme_options.additional_line_colors;this._render_background()},set_background:function(a){if(a.colors)this._theme_options.background_colors=a.colors;if(a.image)this._theme_options.background_image=a.image;this._render_background()},theme_keynote:function(){this._blue="#6886B4";this._yellow="#FDD84E";this._green="#72AE6E";this._red="#D1695E";this._purple="#8A6EAF";this._orange="#EFAA43";this._white="white";this.colors=[this._yellow,this._blue,this._green,this._red,this._purple,this._orange,this._white];this.set_theme({colors:this.colors,marker_color:"white",font_color:"white",background_colors:["black","#4a465a"]})},theme_37signals:function(){this._green="#339933";this._purple="#cc99cc";this._blue="#336699";this._yellow="#FFF804";this._red="#ff0000";this._orange="#cf5910";this._black="black";this.colors=[this._yellow,this._blue,this._green,this._red,this._purple,this._orange,this._black];this.set_theme({colors:this.colors,marker_color:"black",font_color:"black",background_colors:["#d1edf5","white"]})},theme_rails_keynote:function(){this._green="#00ff00";this._grey="#333333";this._orange="#ff5d00";this._red="#f61100";this._white="white";this._light_grey="#999999";this._black="black";this.colors=[this._green,this._grey,this._orange,this._red,this._white,this._light_grey,this._black];this.set_theme({colors:this.colors,marker_color:"white",font_color:"white",background_colors:["#0083a3","#0083a3"]})},theme_odeo:function(){this._grey="#202020";this._white="white";this._dark_pink="#a21764";this._green="#8ab438";this._light_grey="#999999";this._dark_blue="#3a5b87";this._black="black";this.colors=[this._grey,this._white,this._dark_blue,this._dark_pink,this._green,this._light_grey,this._black];this.set_theme({colors:this.colors,marker_color:"white",font_color:"white",background_colors:["#ff47a4","#ff1f81"]})},theme_pastel:function(){this.colors=["#a9dada","#aedaa9","#daaea9","#dadaa9","#a9a9da","#daaeda","#dadada"];this.set_theme({colors:this.colors,marker_color:"#aea9a9",font_color:"black",background_colors:"white"})},theme_greyscale:function(){this.colors=["#282828","#383838","#686868","#989898","#c8c8c8","#e8e8e8"];this.set_theme({colors:this.colors,marker_color:"#aea9a9",font_color:"black",background_colors:"white"})},data:function(a,b,c){b=b===undefined?[]:b;c=c||null;b=Bluff.array(b);this._data.push([a,b,c||this._increment_color()]);this._column_count=b.length>this._column_count?b.length:this._column_count;Bluff.each(b,function(a,b){if(a===undefined)return;if(this.maximum_value===null&&this.minimum_value===null)this.maximum_value=this.minimum_value=a;this.maximum_value=this._larger_than_max(a)?a:this.maximum_value;if(this.maximum_value>=0)this._has_data=true;this.minimum_value=this._less_than_min(a)?a:this.minimum_value;if(this.minimum_value<0)this._has_data=true},this)},draw:function(){if(this.stacked)this._make_stacked();this._setup_drawing();this._debug(function(){this._d.rectangle(this.left_margin,this.top_margin,this._raw_columns-this.right_margin,this._raw_rows-this.bottom_margin);this._d.rectangle(this._graph_left,this._graph_top,this._graph_right,this._graph_bottom)})},clear:function(){this._render_background()},on:function(a,b,c){var d=this._listeners[a]=this._listeners[a]||[];d.push([b,c])},trigger:function(a,b){var c=this._listeners[a];if(!c)return;Bluff.each(c,function(a){a[0].call(a[1],b)})},_setup_drawing:function(){if(!this._has_data)return this._draw_no_data();this._normalize();this._setup_graph_measurements();if(this.sort)this._sort_norm_data();this._draw_legend();this._draw_line_markers();this._draw_axis_labels();this._draw_title()},_normalize:function(a){if(this._norm_data===null||a===true){this._norm_data=[];if(!this._has_data)return;this._calculate_spread();Bluff.each(this._data,function(a){var b=[];Bluff.each(a[this.klass.DATA_VALUES_INDEX],function(a){if(a===null||a===undefined)b.push(null);else b.push((a-this.minimum_value)/this._spread)},this);this._norm_data.push([a[this.klass.DATA_LABEL_INDEX],b,a[this.klass.DATA_COLOR_INDEX]])},this)}},_calculate_spread:function(){this._spread=this.maximum_value-this.minimum_value;this._spread=this._spread>0?this._spread:1;var a=Math.round(Math.LOG10E*Math.log(this._spread));this._significant_digits=Math.pow(10,2-a)},_setup_graph_measurements:function(){this._marker_caps_height=this.hide_line_markers?0:this._calculate_caps_height(this.marker_font_size);this._title_caps_height=this.hide_title?0:this._calculate_caps_height(this.title_font_size);this._legend_caps_height=this.hide_legend?0:this._calculate_caps_height(this.legend_font_size);var a,b,c,d,e,f,g;if(this.hide_line_markers){this._graph_left=this.left_margin;this._graph_right_margin=this.right_margin;this._graph_bottom_margin=this.bottom_margin}else{b=0;if(this.has_left_labels){a="";for(g in this.labels){a=a.length>this.labels[g].length?a:this.labels[g]}b=this._calculate_width(this.marker_font_size,a)*1.25}else{b=this._calculate_width(this.marker_font_size,this._label(this.maximum_value))}c=this.hide_line_numbers&&!this.has_left_labels?0:b+this.klass.LABEL_MARGIN*2;this._graph_left=this.left_margin+c+(this.y_axis_label===null?0:this._marker_caps_height+this.klass.LABEL_MARGIN*2);d=-Infinity;for(g in this.labels)d=d>Number(g)?d:Number(g);d=Math.round(d);e=d>=this._column_count-1&&this.center_labels_over_point?this._calculate_width(this.marker_font_size,this.labels[d])/2:0;this._graph_right_margin=this.right_margin+e;this._graph_bottom_margin=this.bottom_margin+this._marker_caps_height+this.klass.LABEL_MARGIN}this._graph_right=this._raw_columns-this._graph_right_margin;this._graph_width=this._raw_columns-this._graph_left-this._graph_right_margin;this._graph_top=this.top_margin+(this.hide_title?this.title_margin:this._title_caps_height+this.title_margin)+(this.hide_legend?this.legend_margin:this._legend_caps_height+this.legend_margin);f=this.x_axis_label===null?0:this._marker_caps_height+this.klass.LABEL_MARGIN;this._graph_bottom=this._raw_rows-this._graph_bottom_margin-f;this._graph_height=this._graph_bottom-this._graph_top},_draw_axis_labels:function(){if(this.x_axis_label){var a=this._graph_bottom+this.klass.LABEL_MARGIN*2+this._marker_caps_height;this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.stroke="transparent";this._d.pointsize=this._scale_fontsize(this.marker_font_size);this._d.gravity="north";this._d.annotate_scaled(this._raw_columns,1,0,a,this.x_axis_label,this._scale);this._debug(function(){this._d.line(0,a,this._raw_columns,a)})}},_draw_line_markers:function(){if(this.hide_line_markers)return;if(this.y_axis_increment===null){if(this.marker_count===null){Bluff.each([3,4,5,6,7],function(a){if(!this.marker_count&&this._spread%a===0)this.marker_count=a},this);this.marker_count=this.marker_count||4}this._increment=this._spread>0?this._significant(this._spread/this.marker_count):1}else{this.maximum_value=Math.max(Math.ceil(this.maximum_value),this.y_axis_increment);this.minimum_value=Math.floor(this.minimum_value);this._calculate_spread();this._normalize(true);this.marker_count=Math.round(this._spread/this.y_axis_increment);this._increment=this.y_axis_increment}this._increment_scaled=this._graph_height/(this._spread/this._increment);var a,b,c,d;for(a=0,b=this.marker_count;a<=b;a++){c=this._graph_top+this._graph_height-a*this._increment_scaled;this._d.stroke=this.marker_color;this._d.stroke_width=1;this._d.line(this._graph_left,c,this._graph_right,c);d=a*this._increment+this.minimum_value;if(!this.hide_line_numbers){this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.font_weight="normal";this._d.stroke="transparent";this._d.pointsize=this._scale_fontsize(this.marker_font_size);this._d.gravity="east";this._d.annotate_scaled(this._graph_left-this.klass.LABEL_MARGIN,1,0,c,this._label(d),this._scale)}}},_center:function(a){return(this._raw_columns-a)/2},_draw_legend:function(){if(this.hide_legend)return;this._legend_labels=Bluff.map(this._data,function(a){return a[this.klass.DATA_LABEL_INDEX]},this);var a=this.legend_box_size;if(this.font)this._d.font=this.font;this._d.pointsize=this.legend_font_size;var b=[[]];Bluff.each(this._legend_labels,function(c){var d=b.length-1;var e=this._d.get_type_metrics(c);var f=e.width+a*2.7;b[d].push(f);if(Bluff.sum(b[d])>this._raw_columns*.9)b.push([b[d].pop()])},this);var c=this._center(Bluff.sum(b[0]));var d=this.hide_title?this.top_margin+this.title_margin:this.top_margin+this.title_margin+this._title_caps_height;this._debug(function(){this._d.stroke_width=1;this._d.line(0,d,this._raw_columns,d)});Bluff.each(this._legend_labels,function(e,f){this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.pointsize=this._scale_fontsize(this.legend_font_size);this._d.stroke="transparent";this._d.font_weight="normal";this._d.gravity="west";this._d.annotate_scaled(this._raw_columns,1,c+a*1.7,d,e,this._scale);this._d.stroke="transparent";this._d.fill=this._data[f][this.klass.DATA_COLOR_INDEX];this._d.rectangle(c,d-a/2,c+a,d+a/2);this._d.pointsize=this.legend_font_size;var g=this._d.get_type_metrics(e);var h=g.width+a*2.7,i;b[0].shift();if(b[0].length==0){this._debug(function(){this._d.line(0,d,this._raw_columns,d)});b.shift();if(b.length>0)c=this._center(Bluff.sum(b[0]));i=Math.max(this._legend_caps_height,a)+this.legend_margin;if(b.length>0){d+=i;this._graph_top+=i;this._graph_height=this._graph_bottom-this._graph_top}}else{c+=h}},this);this._color_index=0},_draw_title:function(){if(this.hide_title||!this.title)return;this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.pointsize=this._scale_fontsize(this.title_font_size);this._d.font_weight="bold";this._d.gravity="north";this._d.annotate_scaled(this._raw_columns,1,0,this.top_margin,this.title,this._scale)},_draw_label:function(a,b){if(this.hide_line_markers)return;var c;if(this.labels[b]&&!this._labels_seen[b]){c=this._graph_bottom+this.klass.LABEL_MARGIN;this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.stroke="transparent";this._d.font_weight="normal";this._d.pointsize=this._scale_fontsize(this.marker_font_size);this._d.gravity="north";this._d.annotate_scaled(1,1,a,c,this.labels[b],this._scale);this._labels_seen[b]=true;this._debug(function(){this._d.stroke_width=1;this._d.line(0,c,this._raw_columns,c)})}},_draw_tooltip:function(a,b,c,d,e,f,g,h){if(!this.tooltips)return;var i=this._d.tooltip(a,b,c,d,e,f,g);Bluff.Event.observe(i,"click",function(){var a={series:e,label:this.labels[h],value:g,color:f};this.trigger("click:datapoint",a)},this)},_draw_no_data:function(){this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.stroke="transparent";this._d.font_weight="normal";this._d.pointsize=this._scale_fontsize(80);this._d.gravity="center";this._d.annotate_scaled(this._raw_columns,this._raw_rows/2,0,10,this.no_data_message,this._scale)},_render_background:function(){var a=this._theme_options.background_colors;switch(true){case a instanceof Array:this._render_gradiated_background.apply(this,a);break;case typeof a==="string":this._render_solid_background(a);break;default:this._render_image_background(this._theme_options.background_image);break}},_render_solid_background:function(a){this._d.render_solid_background(this._columns,this._rows,a)},_render_gradiated_background:function(a,b){this._d.render_gradiated_background(this._columns,this._rows,a,b)},_render_image_background:function(a){},_reset_themes:function(){this._color_index=0;this._labels_seen={};this._theme_options={};this._d.scale(this._scale,this._scale)},_scale_value:function(a){return this._scale*a},_scale_fontsize:function(a){var b=a*this._scale;return b},_clip_value_if_greater_than:function(a,b){return a>b?b:a},_larger_than_max:function(a,b){return a>this.maximum_value},_less_than_min:function(a,b){return a<this.minimum_value},_max:function(a,b){return a},_min:function(a,b){return a},_significant:function(a){if(a==0)return 1;var b=1;while(a<10){a*=10;b/=10}while(a>100){a/=10;b*=10}return Math.floor(a)*b},_sort_norm_data:function(){var a=this._sums,b=this.klass.DATA_VALUES_INDEX;this._norm_data.sort(function(c,d){return a(d[b])-a(c[b])});this._data.sort(function(c,d){return a(d[b])-a(c[b])})},_sums:function(a){var b=0;Bluff.each(a,function(a){b+=a||0});return b},_make_stacked:function(){var a=[],b=this._column_count;while(b--)a[b]=0;Bluff.each(this._data,function(b){Bluff.each(b[this.klass.DATA_VALUES_INDEX],function(b,c){a[c]+=b},this);b[this.klass.DATA_VALUES_INDEX]=Bluff.array(a)},this)},_debug:function(a){if(this.klass.DEBUG){this._d.fill="transparent";this._d.stroke="turquoise";a.call(this)}},_increment_color:function(){var a=this._color_index;this._color_index=(this._color_index+1)%this.colors.length;return this.colors[a]},_label:function(a){var b=this.klass.THOUSAND_SEPARATOR,c=this._spread%this.marker_count==0||this.y_axis_increment!==null?String(Math.round(a)):String(Math.floor(a*this._significant_digits)/this._significant_digits);var d=c.split(".");d[0]=d[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+b);return d.join(".")},_calculate_caps_height:function(a){return this._d.caps_height(a)},_calculate_width:function(a,b){return this._d.text_width(a,b)}});Bluff.Area=new JS.Class(Bluff.Base,{draw:function(){this.callSuper();if(!this._has_data)return;this._x_increment=this._graph_width/(this._column_count-1);this._d.stroke="transparent";Bluff.each(this._norm_data,function(a){var b=[],c=0,d=0;Bluff.each(a[this.klass.DATA_VALUES_INDEX],function(a,e){var f=this._graph_left+this._x_increment*e;var g=this._graph_top+(this._graph_height-a*this._graph_height);if(c>0&&d>0){b.push(f);b.push(g)}else{b.push(this._graph_left);b.push(this._graph_bottom-1);b.push(f);b.push(g)}this._draw_label(f,e);c=f;d=g},this);b.push(this._graph_right);b.push(this._graph_bottom-1);b.push(this._graph_left);b.push(this._graph_bottom-1);this._d.fill=a[this.klass.DATA_COLOR_INDEX];this._d.polyline(b)},this)}});Bluff.BarConversion=new JS.Class({mode:null,zero:null,graph_top:null,graph_height:null,minimum_value:null,spread:null,getLeftYRightYscaled:function(a,b){var c;switch(this.mode){case 1:b[0]=this.graph_top+this.graph_height*(1-a)+1;b[1]=this.graph_top+this.graph_height-1;break;case 2:b[0]=this.graph_top+1;b[1]=this.graph_top+this.graph_height*(1-a)-1;break;case 3:c=a-this.minimum_value/this.spread;if(a>=this.zero){b[0]=this.graph_top+this.graph_height*(1-(c-this.zero))+1;b[1]=this.graph_top+this.graph_height*(1-this.zero)-1}else{b[0]=this.graph_top+this.graph_height*(1-(c-this.zero))+1;b[1]=this.graph_top+this.graph_height*(1-this.zero)-1}break;default:b[0]=0;b[1]=0}}});Bluff.Bar=new JS.Class(Bluff.Base,{bar_spacing:.9,draw:function(){this.center_labels_over_point=Bluff.keys(this.labels).length>this._column_count;this.callSuper();if(!this._has_data)return;this._draw_bars()},_draw_bars:function(){this._bar_width=this._graph_width/(this._column_count*this._data.length);var a=this._bar_width*(1-this.bar_spacing)/2;this._d.stroke_opacity=0;var b=new Bluff.BarConversion;b.graph_height=this._graph_height;b.graph_top=this._graph_top;if(this.minimum_value>=0){b.mode=1}else{if(this.maximum_value<=0){b.mode=2}else{b.mode=3;b.spread=this._spread;b.minimum_value=this.minimum_value;b.zero=-this.minimum_value/this._spread}}Bluff.each(this._norm_data,function(c,d){var e=this._data[d][this.klass.DATA_VALUES_INDEX];Bluff.each(c[this.klass.DATA_VALUES_INDEX],function(f,g){var h=this._graph_left+this._bar_width*(d+g+(this._data.length-1)*g)+a;var i=h+this._bar_width*this.bar_spacing;var j=[];b.getLeftYRightYscaled(f,j);this._d.fill=c[this.klass.DATA_COLOR_INDEX];this._d.rectangle(h,j[0],i,j[1]);this._draw_tooltip(h,j[0],i-h,j[1]-j[0],c[this.klass.DATA_LABEL_INDEX],c[this.klass.DATA_COLOR_INDEX],e[g],g);var k=this._graph_left+this._data.length*this._bar_width*g+this._data.length*this._bar_width/2;this._draw_label(k-(this.center_labels_over_point?this._bar_width/2:0),g)},this)},this);if(this.center_labels_over_point)this._draw_label(this._graph_right,this._column_count)}});Bluff.Line=new JS.Class(Bluff.Base,{baseline_value:null,baseline_color:null,line_width:null,dot_radius:null,hide_dots:null,hide_lines:null,initialize:function(a){if(arguments.length>3)throw"Wrong number of arguments";if(arguments.length===1||typeof arguments[1]!=="number"&&typeof arguments[1]!=="string")this.callSuper(a,null);else this.callSuper();this.hide_dots=this.hide_lines=false;this.baseline_color="red";this.baseline_value=null},draw:function(){this.callSuper();if(!this._has_data)return;this.x_increment=this._column_count>1?this._graph_width/(this._column_count-1):this._graph_width;var a;if(this._norm_baseline!==undefined){a=this._graph_top+(this._graph_height-this._norm_baseline*this._graph_height);this._d.push();this._d.stroke=this.baseline_color;this._d.fill_opacity=0;this._d.stroke_width=3;this._d.line(this._graph_left,a,this._graph_left+this._graph_width,a);this._d.pop()}Bluff.each(this._norm_data,function(a,b){var c=null,d=null;var e=this._data[b][this.klass.DATA_VALUES_INDEX];this._one_point=this._contains_one_point_only(a);Bluff.each(a[this.klass.DATA_VALUES_INDEX],function(b,f){var g=this._graph_left+this.x_increment*f;if(typeof b!=="number")return;this._draw_label(g,f);var h=this._graph_top+(this._graph_height-b*this._graph_height);this._d.stroke=a[this.klass.DATA_COLOR_INDEX];this._d.fill=a[this.klass.DATA_COLOR_INDEX];this._d.stroke_opacity=1;this._d.stroke_width=this.line_width||this._clip_value_if_greater_than(this._columns/(this._norm_data[0][this.klass.DATA_VALUES_INDEX].length*6),3);var i=this.dot_radius||this._clip_value_if_greater_than(this._columns/(this._norm_data[0][this.klass.DATA_VALUES_INDEX].length*2),7);if(!this.hide_lines&&c!==null&&d!==null){this._d.line(c,d,g,h)}else if(this._one_point){this._d.circle(g,h,g-i,h)}if(!this.hide_dots)this._d.circle(g,h,g-i,h);this._draw_tooltip(g-i,h-i,2*i,2*i,a[this.klass.DATA_LABEL_INDEX],a[this.klass.DATA_COLOR_INDEX],e[f],f);c=g;d=h},this)},this)},_normalize:function(){this.maximum_value=Math.max(this.maximum_value,this.baseline_value);this.callSuper();if(this.baseline_value!==null)this._norm_baseline=this.baseline_value/this.maximum_value},_contains_one_point_only:function(a){var b=0;Bluff.each(a[this.klass.DATA_VALUES_INDEX],function(a){if(a!==undefined)b+=1});return b===1}});Bluff.Dot=new JS.Class(Bluff.Base,{draw:function(){this.has_left_labels=true;this.callSuper();if(!this._has_data)return;var a=1;this._items_width=this._graph_height/this._column_count;this._item_width=this._items_width*a/this._norm_data.length;this._d.stroke_opacity=0;var b=Bluff.array_new(this._column_count,0),c=Bluff.array_new(this._column_count,this._graph_left),d=this._items_width*(1-a)/2;Bluff.each(this._norm_data,function(a,b){Bluff.each(a[this.klass.DATA_VALUES_INDEX],function(c,e){var f=this._graph_left+c*this._graph_width-Math.round(this._item_width/6);var g=this._graph_top+this._items_width*e+d+Math.round(this._item_width/2);if(b===0){this._d.stroke=this.marker_color;this._d.stroke_width=1;this._d.opacity=.1;this._d.line(this._graph_left,g,this._graph_left+this._graph_width,g)}this._d.fill=a[this.klass.DATA_COLOR_INDEX];this._d.stroke="transparent";this._d.circle(f,g,f+Math.round(this._item_width/3),g);var h=this._graph_top+(this._items_width*e+this._items_width/2)+d;this._draw_label(h,e)},this)},this)},_draw_line_markers:function(){if(this.hide_line_markers)return;this._d.stroke_antialias=false;this._d.stroke_width=1;var a=5;var b=this._significant(this.maximum_value/a);for(var c=0;c<=a;c++){var d=(this._graph_right-this._graph_left)/a,e=this._graph_right-d*c-1,f=c-a,g=Math.abs(f)*b;this._d.stroke=this.marker_color;this._d.line(e,this._graph_bottom,e,this._graph_bottom+.5*this.klass.LABEL_MARGIN);if(!this.hide_line_numbers){this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.stroke="transparent";this._d.pointsize=this._scale_fontsize(this.marker_font_size);this._d.gravity="center";this._d.annotate_scaled(0,0,e,this._graph_bottom+this.klass.LABEL_MARGIN*2,g,this._scale)}this._d.stroke_antialias=true}},_draw_label:function(a,b){if(this.labels[b]&&!this._labels_seen[b]){this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.stroke="transparent";this._d.font_weight="normal";this._d.pointsize=this._scale_fontsize(this.marker_font_size);this._d.gravity="east";this._d.annotate_scaled(1,1,this._graph_left-this.klass.LABEL_MARGIN*2,a,this.labels[b],this._scale);this._labels_seen[b]=true}}});Bluff.Net=new JS.Class(Bluff.Base,{hide_dots:null,line_width:null,dot_radius:null,initialize:function(){this.callSuper();this.hide_dots=false;this.hide_line_numbers=true},draw:function(){this.callSuper();if(!this._has_data)return;this._radius=this._graph_height/2;this._center_x=this._graph_left+this._graph_width/2;this._center_y=this._graph_top+this._graph_height/2-10;this._x_increment=this._graph_width/(this._column_count-1);var a=this.dot_radius||this._clip_value_if_greater_than(this._columns/(this._norm_data[0][this.klass.DATA_VALUES_INDEX].length*2.5),7);this._d.stroke_opacity=1;this._d.stroke_width=this.line_width||this._clip_value_if_greater_than(this._columns/(this._norm_data[0][this.klass.DATA_VALUES_INDEX].length*4),3);var b;if(this._norm_baseline!==undefined){b=this._graph_top+(this._graph_height-this._norm_baseline*this._graph_height);this._d.push();this._d.stroke_color=this.baseline_color;this._d.fill_opacity=0;this._d.stroke_width=5;this._d.line(this._graph_left,b,this._graph_left+this._graph_width,b);this._d.pop()}Bluff.each(this._norm_data,function(b){var c=null,d=null;Bluff.each(b[this.klass.DATA_VALUES_INDEX],function(c,d){if(c===undefined)return;var e=d*Math.PI*2/this._column_count,f=c*this._radius,g=this._center_x+Math.sin(e)*f,h=this._center_y-Math.cos(e)*f,i=d+1<b[this.klass.DATA_VALUES_INDEX].length?d+1:0,j=i*Math.PI*2/this._column_count,k=b[this.klass.DATA_VALUES_INDEX][i]*this._radius,l=this._center_x+Math.sin(j)*k,m=this._center_y-Math.cos(j)*k;this._d.stroke=b[this.klass.DATA_COLOR_INDEX];this._d.fill=b[this.klass.DATA_COLOR_INDEX];this._d.line(g,h,l,m);if(!this.hide_dots)this._d.circle(g,h,g-a,h)},this)},this)},_draw_line_markers:function(){if(this.hide_line_markers)return;this._radius=this._graph_height/2;this._center_x=this._graph_left+this._graph_width/2;this._center_y=this._graph_top+this._graph_height/2-10;var a,b;for(var c=0,d=this._column_count;c<d;c++){a=c*Math.PI*2/this._column_count;this._d.stroke=this.marker_color;this._d.stroke_width=1;this._d.line(this._center_x,this._center_y,this._center_x+Math.sin(a)*this._radius,this._center_y-Math.cos(a)*this._radius);b=this.labels[c]?this.labels[c]:"000";this._draw_label(this._center_x,this._center_y,a*360/(2*Math.PI),this._radius,b)}},_draw_label:function(a,b,c,d,e){var f=1.1,g=a,h=b,i=c*Math.PI/180,j=g+d*f*Math.sin(i),k=h-d*f*Math.cos(i);this._d.fill=this.marker_color;if(this.font)this._d.font=this.font;this._d.pointsize=this._scale_fontsize(20);this._d.stroke="transparent";this._d.font_weight="bold";this._d.gravity="center";this._d.annotate_scaled(0,0,j,k,e,this._scale)}});Bluff.Pie=new JS.Class(Bluff.Base,{extend:{TEXT_OFFSET_PERCENTAGE:.08},zero_degreee:null,hide_labels_less_than:null,initialize_ivars:function(){this.callSuper();this.zero_degree=0;this.hide_labels_less_than=0},draw:function(){this.hide_line_markers=true;this.callSuper();if(!this._has_data)return;var a=this._graph_height,b=Math.min(this._graph_width,this._graph_height)/2*.8,c=this._graph_left+(this._graph_width-a)/2,d=this._graph_left+this._graph_width/2,e=this._graph_top+this._graph_height/2-10,f=this._sums_for_pie(),g=this.zero_degree,h=this.klass.DATA_VALUES_INDEX;if(this.sort)this._data.sort(function(a,b){return a[h][0]-b[h][0]});Bluff.each(this._data,function(a,c){if(a[this.klass.DATA_VALUES_INDEX][0]>0){this._d.fill=a[this.klass.DATA_COLOR_INDEX];var h=a[this.klass.DATA_VALUES_INDEX][0]/f*360;this._d.circle(d,e,d+b,e,g,g+h+.5);var i=g+(g+h-g)/2,j=Math.round(a[this.klass.DATA_VALUES_INDEX][0]/f*100),k;if(j>=this.hide_labels_less_than){k=this._label(a[this.klass.DATA_VALUES_INDEX][0]);this._draw_label(d,e,i,b+b*this.klass.TEXT_OFFSET_PERCENTAGE,k,a,c)}g+=h}},this)},_draw_label:function(a,b,c,d,e,f,g){var h=20,i=a,j=b,k=d+h,l=k*.15,m=i+(k+l)*Math.cos(c*Math.PI/180),n=j+k*Math.sin(c*Math.PI/180);this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.pointsize=this._scale_fontsize(this.marker_font_size);this._d.font_weight="bold";this._d.gravity="center";this._d.annotate_scaled(0,0,m,n,e,this._scale);this._draw_tooltip(m-20,n-20,40,40,f[this.klass.DATA_LABEL_INDEX],f[this.klass.DATA_COLOR_INDEX],e,g)},_sums_for_pie:function(){var a=0;Bluff.each(this._data,function(b){a+=b[this.klass.DATA_VALUES_INDEX][0]},this);return a}});Bluff.SideBar=new JS.Class(Bluff.Base,{bar_spacing:.9,draw:function(){this.has_left_labels=true;this.callSuper();if(!this._has_data)return;this._draw_bars()},_draw_bars:function(){this._bars_width=this._graph_height/this._column_count;this._bar_width=this._bars_width/this._norm_data.length;this._d.stroke_opacity=0;var a=Bluff.array_new(this._column_count,0),b=Bluff.array_new(this._column_count,this._graph_left),c=this._bar_width*(1-this.bar_spacing)/2;Bluff.each(this._norm_data,function(d,e){var f=this._data[e][this.klass.DATA_VALUES_INDEX];Bluff.each(d[this.klass.DATA_VALUES_INDEX],function(g,h){var i=this._graph_left+(this._graph_width-g*this._graph_width-a[h]),j=this._graph_left+this._graph_width-a[h],k=j-i,l=b[h]-1,m=this._graph_top+this._bars_width*h+this._bar_width*e+c,n=l+k,o=m+this._bar_width*this.bar_spacing;a[h]+=g*this._graph_width;this._d.stroke="transparent";this._d.fill=d[this.klass.DATA_COLOR_INDEX];this._d.rectangle(l,m,n,o);this._draw_tooltip(l,m,n-l,o-m,d[this.klass.DATA_LABEL_INDEX],d[this.klass.DATA_COLOR_INDEX],f[h],h);var p=this._graph_top+(this._bars_width*h+this._bars_width/2);this._draw_label(p,h)},this)},this)},_draw_line_markers:function(){if(this.hide_line_markers)return;this._d.stroke_antialias=false;this._d.stroke_width=1;var a=5;var b=this._significant(this._spread/a),c,d,e,f;for(var g=0;g<=a;g++){c=(this._graph_right-this._graph_left)/a;d=this._graph_right-c*g-1;e=g-a;f=Math.abs(e)*b+this.minimum_value;this._d.stroke=this.marker_color;this._d.line(d,this._graph_bottom,d,this._graph_top);if(!this.hide_line_numbers){this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.stroke="transparent";this._d.pointsize=this._scale_fontsize(this.marker_font_size);this._d.gravity="center";this._d.annotate_scaled(0,0,d,this._graph_bottom+this.klass.LABEL_MARGIN*2,this._label(f),this._scale)}}},_draw_label:function(a,b){if(this.labels[b]&&!this._labels_seen[b]){this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.stroke="transparent";this._d.font_weight="normal";this._d.pointsize=this._scale_fontsize(this.marker_font_size);this._d.gravity="east";this._d.annotate_scaled(1,1,this._graph_left-this.klass.LABEL_MARGIN*2,a,this.labels[b],this._scale);this._labels_seen[b]=true}}});Bluff.Spider=new JS.Class(Bluff.Base,{hide_text:null,hide_axes:null,transparent_background:null,initialize:function(a,b,c){this.callSuper(a,c);this._max_value=b;this.hide_legend=true},draw:function(){this.hide_line_markers=true;this.callSuper();if(!this._has_data)return;var a=this._graph_height,b=this._graph_height/2,c=this._graph_left+(this._graph_width-a)/2,d=this._graph_left+this._graph_width/2,e=this._graph_top+this._graph_height/2-25;this._unit_length=b/this._max_value;var f=this._sums_for_spider(),g=0,h=2*Math.PI/this._data.length,i=0;if(!this.hide_axes)this._draw_axes(d,e,b,h);this._draw_polygon(d,e,h)},_normalize_points:function(a){return a*this._unit_length},_draw_label:function(a,b,c,d,e){var f=50,g=a,h=b+0,i=g+(d+f)*Math.cos(c),j=h+(d+f)*Math.sin(c);this._d.fill=this.marker_color;if(this.font)this._d.font=this.font;this._d.pointsize=this._scale_fontsize(this.legend_font_size);this._d.stroke="transparent";this._d.font_weight="bold";this._d.gravity="center";this._d.annotate_scaled(0,0,i,j,e,this._scale)},_draw_axes:function(a,b,c,d,e){if(this.hide_axes)return;var f=0;Bluff.each(this._data,function(g){this._d.stroke=e||g[this.klass.DATA_COLOR_INDEX];this._d.stroke_width=5;var h=c*Math.cos(f);var i=c*Math.sin(f);this._d.line(a,b,a+h,b+i);if(!this.hide_text)this._draw_label(a,b,f,c,g[this.klass.DATA_LABEL_INDEX]);f+=d},this)},_draw_polygon:function(a,b,c,d){var e=[],f=0;Bluff.each(this._data,function(d){e.push(a+this._normalize_points(d[this.klass.DATA_VALUES_INDEX][0])*Math.cos(f));e.push(b+this._normalize_points(d[this.klass.DATA_VALUES_INDEX][0])*Math.sin(f));f+=c},this);this._d.stroke_width=1;this._d.stroke=d||this.marker_color;this._d.fill=d||this.marker_color;this._d.fill_opacity=.4;this._d.polyline(e)},_sums_for_spider:function(){var a=0;Bluff.each(this._data,function(b){a+=b[this.klass.DATA_VALUES_INDEX][0]},this);return a}});Bluff.Base.StackedMixin=new JS.Module({_get_maximum_by_stack:function(){var a={};Bluff.each(this._data,function(b){Bluff.each(b[this.klass.DATA_VALUES_INDEX],function(b,c){if(!a[c])a[c]=0;a[c]+=b},this)},this);for(var b in a){if(a[b]>this.maximum_value)this.maximum_value=a[b]}this.minimum_value=0}});Bluff.StackedArea=new JS.Class(Bluff.Base,{include:Bluff.Base.StackedMixin,last_series_goes_on_bottom:null,draw:function(){this._get_maximum_by_stack();this.callSuper();if(!this._has_data)return;this._x_increment=this._graph_width/(this._column_count-1);this._d.stroke="transparent";var a=Bluff.array_new(this._column_count,0);var b=null;var c=this.last_series_goes_on_bottom?"reverse_each":"each";Bluff[c](this._norm_data,function(c){var d=b;b=[];Bluff.each(c[this.klass.DATA_VALUES_INDEX],function(c,d){var e=this._graph_left+this._x_increment*d;var f=this._graph_top+(this._graph_height-c*this._graph_height-a[d]);a[d]+=c*this._graph_height;b.push(e);b.push(f);this._draw_label(e,d)},this);var e,f,g;if(d){e=Bluff.array(b);for(f=d.length/2-1;f>=0;f--){e.push(d[2*f]);e.push(d[2*f+1])}e.push(b[0]);e.push(b[1])}else{e=Bluff.array(b);e.push(this._graph_right);e.push(this._graph_bottom-1);e.push(this._graph_left);e.push(this._graph_bottom-1);e.push(b[0]);e.push(b[1])}this._d.fill=c[this.klass.DATA_COLOR_INDEX];this._d.polyline(e)},this)}});Bluff.StackedBar=new JS.Class(Bluff.Base,{include:Bluff.Base.StackedMixin,bar_spacing:.9,draw:function(){this._get_maximum_by_stack();this.callSuper();if(!this._has_data)return;this._bar_width=this._graph_width/this._column_count;var a=this._bar_width*(1-this.bar_spacing)/2;this._d.stroke_opacity=0;var b=Bluff.array_new(this._column_count,0);Bluff.each(this._norm_data,function(c,d){var e=this._data[d][this.klass.DATA_VALUES_INDEX];Bluff.each(c[this.klass.DATA_VALUES_INDEX],function(d,f){var g=this._graph_left+this._bar_width*f+this._bar_width*this.bar_spacing/2;this._draw_label(g,f);if(d==0)return;var h=this._graph_left+this._bar_width*f+a;var i=this._graph_top+(this._graph_height-d*this._graph_height-b[f])+1;var j=h+this._bar_width*this.bar_spacing;var k=this._graph_top+this._graph_height-b[f]-1;b[f]+=d*this._graph_height;this._d.fill=c[this.klass.DATA_COLOR_INDEX];this._d.rectangle(h,i,j,k);this._draw_tooltip(h,i,j-h,k-i,c[this.klass.DATA_LABEL_INDEX],c[this.klass.DATA_COLOR_INDEX],e[f],f)},this)},this)}});Bluff.AccumulatorBar=new JS.Class(Bluff.StackedBar,{draw:function(){if(this._data.length!==1)throw"Incorrect number of datasets";var a=[],b=0,c=[];Bluff.each(this._data[0][this.klass.DATA_VALUES_INDEX],function(d){var e=-Infinity;Bluff.each(c,function(a){e=Math.max(e,a)});c.push(b>0?d+e:d);a.push(c[b]-d);b+=1},this);this.data("Accumulator",a);this.callSuper()}});Bluff.SideStackedBar=new JS.Class(Bluff.SideBar,{include:Bluff.Base.StackedMixin,bar_spacing:.9,draw:function(){this.has_left_labels=true;this._get_maximum_by_stack();this.callSuper()},_draw_bars:function(){this._bar_width=this._graph_height/this._column_count;var a=Bluff.array_new(this._column_count,0),b=Bluff.array_new(this._column_count,this._graph_left),c=this._bar_width*(1-this.bar_spacing)/2;Bluff.each(this._norm_data,function(d,e){var f=this._data[e][this.klass.DATA_VALUES_INDEX];Bluff.each(d[this.klass.DATA_VALUES_INDEX],function(e,g){var h=this._graph_left+(this._graph_width-e*this._graph_width-a[g])+1;var i=this._graph_left+this._graph_width-a[g]-1;var j=i-h;this._d.fill=d[this.klass.DATA_COLOR_INDEX];var k=b[g],l=this._graph_top+this._bar_width*g+c,m=k+j,n=l+this._bar_width*this.bar_spacing;b[g]+=j;a[g]+=e*this._graph_width-2;this._d.rectangle(k,l,m,n);this._draw_tooltip(k,l,m-k,n-l,d[this.klass.DATA_LABEL_INDEX],d[this.klass.DATA_COLOR_INDEX],f[g],g);var o=this._graph_top+this._bar_width*g+this._bar_width*this.bar_spacing/2;this._draw_label(o,g)},this)},this)},_larger_than_max:function(a,b){b=b||0;return this._max(a,b)>this.maximum_value},_max:function(a,b){var c=0;Bluff.each(this._data,function(a){c+=a[this.klass.DATA_VALUES_INDEX][b]},this);return c}});Bluff.Mini.Legend=new JS.Module({hide_mini_legend:false,_expand_canvas_for_vertical_legend:function(){if(this.hide_mini_legend)return;this._legend_labels=Bluff.map(this._data,function(a){return a[this.klass.DATA_LABEL_INDEX]},this);var a=this._scale_fontsize(this._data.length*this._calculate_line_height()+this.top_margin+this.bottom_margin);this._original_rows=this._raw_rows;this._original_columns=this._raw_columns;switch(this.legend_position){case"right":this._rows=Math.max(this._rows,a);this._columns+=this._calculate_legend_width()+this.left_margin;break;default:this._rows+=a;break}this._render_background()},_calculate_line_height:function(){return this._calculate_caps_height(this.legend_font_size)*1.7},_calculate_legend_width:function(){var a=0;Bluff.each(this._legend_labels,function(b){a=Math.max(this._calculate_width(this.legend_font_size,b),a)},this);return this._scale_fontsize(a+40*1.7)},_draw_vertical_legend:function(){if(this.hide_mini_legend)return;var a=40,b=10,c=100,d=40;if(this.font)this._d.font=this.font;this._d.pointsize=this.legend_font_size;var e,f;switch(this.legend_position){case"right":e=this._original_columns+this.left_margin;f=this.top_margin+d;break;default:e=c,f=this._original_rows+d;break}this._debug(function(){this._d.line(0,f,this._raw_columns,f)});Bluff.each(this._legend_labels,function(b,c){this._d.fill=this.font_color;if(this.font)this._d.font=this.font;this._d.pointsize=this._scale_fontsize(this.legend_font_size);this._d.stroke="transparent";this._d.font_weight="normal";this._d.gravity="west";this._d.annotate_scaled(this._raw_columns,1,e+a*1.7,f,this._truncate_legend_label(b),this._scale);this._d.stroke="transparent";this._d.fill=this._data[c][this.klass.DATA_COLOR_INDEX];this._d.rectangle(e,f-a/2,e+a,f+a/2);f+=this._calculate_line_height()},this);this._color_index=0},_truncate_legend_label:function(a){var b=String(a);while(this._calculate_width(this._scale_fontsize(this.legend_font_size),b)>this._columns-this.legend_left_margin-this.right_margin&&b.length>1)b=b.substr(0,b.length-1);return b+(b.length<String(a).length?"...":"")}});Bluff.Mini.Bar=new JS.Class(Bluff.Bar,{include:Bluff.Mini.Legend,initialize_ivars:function(){this.callSuper();this.hide_legend=true;this.hide_title=true;this.hide_line_numbers=true;this.marker_font_size=50;this.minimum_value=0;this.maximum_value=0;this.legend_font_size=60},draw:function(){this._expand_canvas_for_vertical_legend();this.callSuper();this._draw_vertical_legend()}});Bluff.Mini.Pie=new JS.Class(Bluff.Pie,{include:Bluff.Mini.Legend,initialize_ivars:function(){this.callSuper();this.hide_legend=true;this.hide_title=true;this.hide_line_numbers=true;this.marker_font_size=60;this.legend_font_size=60},draw:function(){this._expand_canvas_for_vertical_legend();this.callSuper();this._draw_vertical_legend()}});Bluff.Mini.SideBar=new JS.Class(Bluff.SideBar,{include:Bluff.Mini.Legend,initialize_ivars:function(){this.callSuper();this.hide_legend=true;this.hide_title=true;this.hide_line_numbers=true;this.marker_font_size=50;this.legend_font_size=50},draw:function(){this._expand_canvas_for_vertical_legend();this.callSuper();this._draw_vertical_legend()}});Bluff.Renderer=new JS.Class({extend:{WRAPPER_CLASS:"bluff-wrapper",TEXT_CLASS:"bluff-text",TARGET_CLASS:"bluff-tooltip-target"},font:"Arial, Helvetica, Verdana, sans-serif",gravity:"north",initialize:function(a){this._canvas=document.getElementById(a);this._ctx=this._canvas.getContext("2d")},scale:function(a,b){this._sx=a;this._sy=b||a},caps_height:function(a){var b=this._sized_text(a,"X"),c=this._element_size(b).height;this._remove_node(b);return c},text_width:function(a,b){var c=this._sized_text(a,b);var d=this._element_size(c).width;this._remove_node(c);return d},get_type_metrics:function(a){var b=this._sized_text(this.pointsize,a);document.body.appendChild(b);var c=this._element_size(b);this._remove_node(b);return c},clear:function(a,b){this._canvas.width=a;this._canvas.height=b;this._ctx.clearRect(0,0,a,b);var c=this._text_container(),d=c.childNodes,e=d.length;c.style.width=a+"px";c.style.height=b+"px";while(e--){if(d[e].tagName.toLowerCase()!=="canvas"){Bluff.Event.stopObserving(d[e]);this._remove_node(d[e])}}},push:function(){this._ctx.save()},pop:function(){this._ctx.restore()},render_gradiated_background:function(a,b,c,d){this.clear(a,b);var e=this._ctx.createLinearGradient(0,0,0,b);e.addColorStop(0,c);e.addColorStop(1,d);this._ctx.fillStyle=e;this._ctx.fillRect(0,0,a,b)},render_solid_background:function(a,b,c){this.clear(a,b);this._ctx.fillStyle=c;this._ctx.fillRect(0,0,a,b)},annotate_scaled:function(a,b,c,d,e,f){var g=a*f>=1?a*f:1;var h=b*f>=1?b*f:1;var e=this._sized_text(this.pointsize,e);e.style.color=this.fill;e.style.cursor="default";e.style.fontWeight=this.font_weight;e.style.textAlign="center";e.style.left=this._sx*c+this._left_adjustment(e,g)+"px";e.style.top=this._sy*d+this._top_adjustment(e,h)+"px"},tooltip:function(a,b,c,d,e,f,g){if(c<0)a+=c;if(d<0)b+=d;var h=this._canvas.parentNode,i=document.createElement("div");i.className=this.klass.TARGET_CLASS;i.style.cursor="default";i.style.position="absolute";i.style.left=this._sx*a-3+"px";i.style.top=this._sy*b-3+"px";i.style.width=this._sx*Math.abs(c)+5+"px";i.style.height=this._sy*Math.abs(d)+5+"px";i.style.fontSize=0;i.style.overflow="hidden";Bluff.Event.observe(i,"mouseover",function(a){Bluff.Tooltip.show(e,f,g)});Bluff.Event.observe(i,"mouseout",function(a){Bluff.Tooltip.hide()});h.appendChild(i);return i},circle:function(a,b,c,d,e,f){var g=Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2));var h=0,i=2*Math.PI;this._ctx.fillStyle=this.fill;this._ctx.beginPath();if(e!==undefined&&f!==undefined&&Math.abs(Math.floor(f-e))!==360){h=e*Math.PI/180;i=f*Math.PI/180;this._ctx.moveTo(this._sx*(a+g*Math.cos(i)),this._sy*(b+g*Math.sin(i)));this._ctx.lineTo(this._sx*a,this._sy*b);this._ctx.lineTo(this._sx*(a+g*Math.cos(h)),this._sy*(b+g*Math.sin(h)))}this._ctx.arc(this._sx*a,this._sy*b,this._sx*g,h,i,false);this._ctx.fill()},line:function(a,b,c,d){this._ctx.strokeStyle=this.stroke;this._ctx.lineWidth=this.stroke_width;this._ctx.beginPath();this._ctx.moveTo(this._sx*a,this._sy*b);this._ctx.lineTo(this._sx*c,this._sy*d);this._ctx.stroke()},polyline:function(a){this._ctx.fillStyle=this.fill;this._ctx.globalAlpha=this.fill_opacity||1;try{this._ctx.strokeStyle=this.stroke}catch(b){}var c=a.shift(),d=a.shift();this._ctx.beginPath();this._ctx.moveTo(this._sx*c,this._sy*d);while(a.length>0){c=a.shift();d=a.shift();this._ctx.lineTo(this._sx*c,this._sy*d)}this._ctx.fill()},rectangle:function(a,b,c,d){var e;if(a>c){e=a;a=c;c=e}if(b>d){e=b;b=d;d=e}try{this._ctx.fillStyle=this.fill;this._ctx.fillRect(this._sx*a,this._sy*b,this._sx*(c-a),this._sy*(d-b))}catch(f){}try{this._ctx.strokeStyle=this.stroke;if(this.stroke!=="transparent")this._ctx.strokeRect(this._sx*a,this._sy*b,this._sx*(c-a),this._sy*(d-b))}catch(f){}},_left_adjustment:function(a,b){var c=this._element_size(a).width;switch(this.gravity){case"west":return 0;case"east":return b-c;case"north":case"south":case"center":return(b-c)/2}},_top_adjustment:function(a,b){var c=this._element_size(a).height;switch(this.gravity){case"north":return 0;case"south":return b-c;case"west":case"east":case"center":return(b-c)/2}},_text_container:function(){var a=this._canvas.parentNode;if(a.className===this.klass.WRAPPER_CLASS)return a;a=document.createElement("div");a.className=this.klass.WRAPPER_CLASS;a.style.position="relative";a.style.border="none";a.style.padding="0 0 0 0";this._canvas.parentNode.insertBefore(a,this._canvas);a.appendChild(this._canvas);return a},_sized_text:function(a,b){var c=this._text_node(b);c.style.fontFamily=this.font;c.style.fontSize=typeof a==="number"?a+"px":a;return c},_text_node:function(a){var b=document.createElement("div");b.className=this.klass.TEXT_CLASS;b.style.position="absolute";b.appendChild(document.createTextNode(a));this._text_container().appendChild(b);return b},_remove_node:function(a){a.parentNode.removeChild(a);if(a.className===this.klass.TARGET_CLASS)Bluff.Event.stopObserving(a)},_element_size:function(a){var b=a.style.display;return b&&b!=="none"?{width:a.offsetWidth,height:a.offsetHeight}:{width:a.clientWidth,height:a.clientHeight}}});Bluff.Event={_cache:[],_isIE:window.attachEvent&&navigator.userAgent.indexOf("Opera")===-1,observe:function(a,b,c,d){var e=Bluff.map(this._handlersFor(a,b),function(a){return a._handler});if(Bluff.index(e,c)!==-1)return;var f=function(b){c.call(d||null,a,Bluff.Event._extend(b))};this._cache.push({_node:a,_name:b,_handler:c,_responder:f});if(a.addEventListener)a.addEventListener(b,f,false);else a.attachEvent("on"+b,f)},stopObserving:function(a){var b=a?this._handlersFor(a):this._cache;Bluff.each(b,function(a){if(a._node.removeEventListener)a._node.removeEventListener(a._name,a._responder,false);else a._node.detachEvent("on"+a._name,a._responder)})},_handlersFor:function(a,b){var c=[];Bluff.each(this._cache,function(d){if(a&&d._node!==a)return;if(b&&d._name!==b)return;c.push(d)});return c},_extend:function(a){if(!this._isIE)return a;if(!a)return false;if(a._extendedByBluff)return a;a._extendedByBluff=true;var b=this._pointer(a);a.target=a.srcElement;a.pageX=b.x;a.pageY=b.y;return a},_pointer:function(a){var b=document.documentElement,c=document.body||{scrollLeft:0,scrollTop:0};return{x:a.pageX||a.clientX+(b.scrollLeft||c.scrollLeft)-(b.clientLeft||0),y:a.pageY||a.clientY+(b.scrollTop||c.scrollTop)-(b.clientTop||0)}}};if(Bluff.Event._isIE)window.attachEvent("onunload",function(){Bluff.Event.stopObserving();Bluff.Event._cache=null});if(navigator.userAgent.indexOf("AppleWebKit/")>-1)window.addEventListener("unload",function(){},false);Bluff.Tooltip=new JS.Singleton({LEFT_OFFSET:20,TOP_OFFSET:-6,DATA_LENGTH:8,CLASS_NAME:"bluff-tooltip",setup:function(){this._tip=document.createElement("div");this._tip.className=this.CLASS_NAME;this._tip.style.position="absolute";this.hide();document.body.appendChild(this._tip);Bluff.Event.observe(document.body,"mousemove",function(a,b){this._tip.style.left=b.pageX+this.LEFT_OFFSET+"px";this._tip.style.top=b.pageY+this.TOP_OFFSET+"px"},this)},show:function(a,b,c){c=Number(String(c).substr(0,this.DATA_LENGTH));this._tip.innerHTML='<span class="color" style="background: '+b+';"> </span> '+'<span class="label">'+a+"</span> "+'<span class="data">'+c+"</span>";this._tip.style.display=""},hide:function(){this._tip.style.display="none"}});Bluff.Event.observe(window,"load",Bluff.Tooltip.method("setup"));Bluff.TableReader=new JS.Class({NUMBER_FORMAT:/\-?(0|[1-9]\d*)(\.\d+)?(e[\+\-]?\d+)?/i,initialize:function(a,b){this._options=b||{};this._orientation=this._options.orientation||"auto";this._table=typeof a==="string"?document.getElementById(a):a},get_data:function(){if(!this._data)this._read();return this._data},get_labels:function(){if(!this._labels)this._read();return this._labels},get_title:function(){return this._title},get_series:function(a){if(this._data[a])return this._data[a];return this._data[a]={points:[]}},_read:function(){this._row=this._col=0;this._row_offset=this._col_offset=0;this._data=[];this._labels={};this._row_headings=[];this._col_headings=[];this._skip_rows=[];this._skip_cols=[];this._walk(this._table);this._cleanup();this._orient();Bluff.each(this._col_headings,function(a,b){this.get_series(b-this._col_offset).name=a},this);Bluff.each(this._row_headings,function(a,b){this._labels[b-this._row_offset]=a},this)},_walk:function(a){this._visit(a);var b,c=a.childNodes,d=c.length;for(b=0;b<d;b++)this._walk(c[b])},_visit:function(a){if(!a.tagName)return;var b=this._strip_tags(a.innerHTML),c,d;switch(a.tagName.toUpperCase()){case"TR":if(!this._has_data)this._row_offset=this._row;this._row+=1;this._col=0;break;case"TD":if(!this._has_data)this._col_offset=this._col;this._has_data=true;this._col+=1;b=b.match(this.NUMBER_FORMAT);if(b===null){this.get_series(c).points[d]=null}else{c=this._col-this._col_offset-1;d=this._row-this._row_offset-1;this.get_series(c).points[d]=parseFloat(b[0])}break;case"TH":this._col+=1;if(this._ignore(a)){this._skip_cols.push(this._col);this._skip_rows.push(this._row)}if(this._col===1&&this._row===1)this._row_headings[0]=this._col_headings[0]=b;else if(a.scope==="row"||this._col===1)this._row_headings[this._row-1]=b;else this._col_headings[this._col-1]=b;break;case"CAPTION":this._title=b;break}},_ignore:function(a){if(!this._options.except)return false;var b=this._strip_tags(a.innerHTML),c=(a.className||"").split(/\s+/),d=[].concat(this._options.except);if(Bluff.index(d,b)>=0)return true;var e=c.length;while(e--){if(Bluff.index(d,c[e])>=0)return true}return false},_cleanup:function(){var a=this._skip_cols.length,b;while(a--){b=this._skip_cols[a];if(b<=this._col_offset)continue;this._col_headings.splice(b-1,1);if(b>=this._col_offset)this._data.splice(b-1-this._col_offset,1)}var a=this._skip_rows.length,b;while(a--){b=this._skip_rows[a];if(b<=this._row_offset)continue;this._row_headings.splice(b-1,1);Bluff.each(this._data,function(a){if(b>=this._row_offset)a.points.splice(b-1-this._row_offset,1)},this)}},_orient:function(){switch(this._orientation){case"auto":if(this._row_headings.length>1&&this._col_headings.length===1||this._row_headings.length<this._col_headings.length){this._transpose()}break;case"rows":this._transpose();break}},_transpose:function(){var a=this._data,b;this._data=[];Bluff.each(a,function(a,b){Bluff.each(a.points,function(a,c){this.get_series(c).points[b]=a},this)},this);b=this._row_headings;this._row_headings=this._col_headings;this._col_headings=b;b=this._row_offset;this._row_offset=this._col_offset;this._col_offset=b},_strip_tags:function(a){return a.replace(/<\/?[^>]+>/gi,"")},extend:{Mixin:new JS.Module({data_from_table:function(a,b){var c=new Bluff.TableReader(a,b),d=c.get_data();Bluff.each(d,function(a){this.data(a.name,a.points)},this);this.labels=c.get_labels();this.title=c.get_title()||this.title}})}});Bluff.Base.include(Bluff.TableReader.Mixin)