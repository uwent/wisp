<% content_for :title do %>
  WISP: Wisconsin Irrigation Scheduling Program <%= Time.now.year %>
<% end %>

<% content_for :stylesheet do %>
  <%= stylesheet_link_tag "style" -%>
  <%= jqgrid_stylesheets.html_safe -%>
  <style type="text/css">
	h2 {text-align:center;}
	
	#fieldSelectionBox
	{
	  text-align: center;
	}

	#fieldDataBox
	{
		position:absolute;
		left:275px;
		top:173px;
		width:205px;
		height:203px;
		padding:2px;
		border:1px solid gray;
		margin:0px;
	}

	#tableDataBox
	{
		position:absolute;
		left:500px;
		top:173px;
		width:690px;
		padding:2px;
		margin:0px;
	}

	#tableDataBox table tr td.editable
	{
		background:white
	}

	#graphBox
	{
		position:absolute;
		left:275px;
		top:400px;
		width:575px;
		padding:2px;
		border:1px solid gray;
		margin:0px;
	}
	
	#projectedADBox
	{
		position:absolute;
		left:875px;
		top:400px;
		width:300px;
		height:300px;
		padding:2px;
		border:1px solid gray;
		margin:0px;
	}
	
	#imageADBox
	{
		position:absolute;
		left:875px;
		top:375px;
		width:300px;
	}
	
	table.center
	{
	  margin-left:auto;
	  margin-right:auto;
	}
	</style>
   </style>
<% end %>
<%= content_for :scripts do %>
  <%= jqgrid_javascripts.html_safe %>
  <%= javascript_include_tag 'bluff/js-class.js'  %>
  <%= javascript_include_tag 'bluff/excanvas.js'  %>
  <%= javascript_include_tag 'bluff/bluff-min.js' %>
  <script type="text/javascript">
    <%= grid_javascript_settings %>
    var cur_date = '<%= @cur_date %>;'
    var initial_date = '<%= @initial_date %>';
    // Support Safari and other stupid browsers whose Date objects are nonstandard
    function parseDate(input) {
      var parts = input.match(/(\d+)/g);
      return new Date(parts[0], parts[1]-1, parts[2]);
    }
    function curPage(initial_date_str,cur_date_str) {
      initial_date_obj = parseDate(initial_date_str);
      // set the global
      cur_date = cur_date_str;
      cur_date_obj = parseDate(cur_date_str);
      days = (cur_date_obj.getTime() - initial_date_obj.getTime()) / (86400 * 1000);
      return(Math.ceil(days / 7));
    }
    function showSummaryBox(date) {
      $('#projectedADBox').load("<%= url_for(:controller => 'wisp', :action => :summary_box, :field_id => @field, :user_id => @user) %>&cur_date="+date);
    }
    function showTargetAD() {
      // adValue = 0.0;
      adValue = <%= @field.target_ad_pct || "''" %>;
      document.getElementById('target_ad').value = adValue;
    }
    function setTargetAD() {
      val = document.getElementById('target_ad').value;
      $.ajax(
      { 
          type: "POST",
          url: '<%= url_for(:controller => :fields, :action => :update_target_ad_pct, :user_id => @user, :id => @field[:id]) %>&target_ad_pct='+val,
          dataType: "json",
          async: false,
          success: function(json)
          {
            adValue = json['target_ad_pct']
            document.getElementById('target_ad').value = adValue;
            document.getElementById('target_ad_in').innerHTML = json['target_ad_in'];
            plotGraph();
            showSummaryBox(cur_date);
          }, /* success: */
          error: function(xhr, textStatus, errorThrown)
          { 
              alert(textStatus + ' ' + errorThrown);
              ad_data = [];
              projected_ad_data = [];
          } /* error: */
      });/* $.ajax */
    }
    function plotGraph() {
      var g = new Bluff.Line('example', '575x300');
      var ad_data;
      var projected_ad_data = [];
      var target_ad_data = [];
      g.title = 'Allowable Depletion (inches)';
      g.tooltips = true;
      g.set_theme({
          colors: ['#202020', 'white', '#a21764', '#8ab438',
                   '#999999', '#3a5b87', 'black'],
          marker_color: '#aea9a9',
          font_color: 'black',
          background_colors: ['#d0e0f8', '#f0f0ff']
        });
        url = '<%= url_for(:action => :projection_data, :field_id => @field_id, :user_id => @user) %>&cur_date='+cur_date;
        $.ajax(
        { 
            type: "GET",
            url: url, 
            dataType: "json",
            async: false,
            success: function(json)
            {
              ad_data = json['ad_data'];
              prj_data = json['projected_ad_data'];
              targ_data = json['target_ad_data'];
              labels = json['labels'];
              for (var ii=0,len=ad_data.length; ii<len; ii++) {
                projected_ad_data.push(ad_data[ii]);
              }
              for (ii=0,len=prj_data.length; ii<len; ii++) {
                projected_ad_data.push(prj_data[ii]);
              }
              if (targ_data != null) {
                for (ii=0,len=targ_data.length; ii<len; ii++) {
                  target_ad_data.push(targ_data[ii]);
                }
              }
            }, /* success: */
            error: function(xhr, textStatus, errorThrown)
            { 
                alert(textStatus + ' ' + errorThrown);
                ad_data = [];
                projected_ad_data = [];
            } /* error: */
        });/* $.ajax */
      g.data("Projected AD", projected_ad_data,'#26c202');
      g.data("Allowable Depletion", ad_data,'blue');
      if (targ_data != null) {
        g.data("Target AD",target_ad_data,'gray');
      }
      g.hide_legend = false;
      g.labels = labels; // {<%= @date_str %>};
      g.draw();
    }
    jQuery(document).ready(function(){
      plotGraph();
      showSummaryBox(cur_date);
      showTargetAD();
      
      $("#date_input").change(function(){
        cur_date = $('#date_input').val();
        cur_page = curPage(initial_date,cur_date);
        $("#weather").setGridParam({ page: cur_page }).trigger("reloadGrid");
        plotGraph();
        showSummaryBox(cur_date);
      });
      
    });
    
  </script>
  
<% end %>

<% content_for :welcome do %>
  <%= render :partial => 'sidebar' %>
<% end %>

<h2 style="margin-top:0px;padding-top:0px">WISP Field Status</h2>
<div id="fieldSelectionBox">
  <table class="center" style="margin-top:10px">
  <tr>
    <td>
      <td>
        <%= form_tag(url_for :controller => "wisp", :action => :field_status, :pivot_id => "", :field_id => "") do %>
          <%= select_tag "farm_id", options_from_group_for_select(@group, @farm),{ :onchange => "this.form.submit();"} %> 
        <% end %>      
      </td>
      
    </td>
    <td>
      <%= form_tag(url_for :controller => "wisp", :action => :field_status, :field_id => "") do %>
        <%= select_tag "pivot_id", options_from_farm_for_select(@farm, @pivot),{ :onchange => "this.form.submit();"} %> 
      <% end %>      
    </td>
    <td>
      <%= form_tag(url_for :controller => "wisp", :action => :field_status) do %>
        <%= select_tag "field_id", options_from_pivot_for_select(@pivot, @field),{ :onchange => "this.form.submit();"} %> 
      <% end %>
    </td>
    <td>
      <script>
      $(function() {
        <% if @cur_date %>
          $( "#date_input" ).datepicker({dateFormat: 'yy-mm-dd', defaultDate:<%= @cur_date %>});
        <% else %>
          $( "#date_input" ).datepicker({dateFormat: 'yy-mm-dd'});
        <% end %>
      });
      </script>
      Date: <input name="date_input" id="date_input" class='date_input' size="10" value="<%= @cur_date %>"></input>
    </td>
  </tr></table>
</div>

<div id="fieldDataBox">
<h2 style="padding:5px">Field Data</h2>
Farm: <%= truncate(@farm.name, :length => 28) if @farm %><br/>
Pivot: <%= truncate(@pivot.name, :length => 28) if @pivot %><br/>
Field/soil: <%= truncate(@field.name, :length => 20) %><br/>
Crop: <%= truncate((@field.current_crop.name + " " + @field.current_crop.variety), :length => 28) %><br/>   
<hr/>
Root zone depth: <%= @field.current_crop.max_root_zone_depth if @field && @field.current_crop %> in<br/>
Emergence Date: <%= abr(@field.current_crop.emergence_date) if @field && @field.current_crop %><br/>
Total AD: <%= sprintf("%0.2f",@field.ad_max) %> in.<br/>
Init. soil moist.: <%= sprintf("%0.0f",@field_weather_data.first.pct_moisture)  if @field_weather_data && @field_weather_data.size > 0 %> %<br/>
<% target_ad_in_str = @field.target_ad_in ? sprintf('%0.2f"',@field.target_ad_in) : '--' %>
Target:&nbsp;<input name="field[target_ad_pct]" id="target_ad" size="1"/>%&nbsp;(<div style="display:inline" id='target_ad_in'><%= target_ad_in_str %></div>)&nbsp;<input type="button" value="Update" onclick="setTargetAD();"/>

</div>

<%= render :partial => 'wisp/partials/field_daily_wx'%>

<div id="graphBox">
  <canvas id="example" width="400" height="300"></canvas>
</div>

<div id="projectedADBox">
<%= render :partial => 'wisp/partials/summary_box'%>
</div>
